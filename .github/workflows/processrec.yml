name: Telegram Reminders

permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug mode'
        required: false
        default: 'false'
  
  schedule:
    - cron: "0 * * * *"  # ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ñ‡Ð°Ñ (Ð² Ð½Ð°Ñ‡Ð°Ð»Ðµ Ñ‡Ð°ÑÐ°, Ð¿Ð¾ UTC)
  
  push:
    branches:
      - main
    paths:
      - '.github/workflows/**'  # Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¸ workflow-Ñ„Ð°Ð¹Ð»Ð¾Ð²

jobs:
  run-script:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      CLICKUP_API_KEY: ${{ secrets.CLICKUP_API_KEY }}
      CLICKUP_TEAM_ID: ${{ secrets.CLICKUP_TEAM_ID }}
      CLICKUP_WORKSPACE_ID: ${{ secrets.CLICKUP_WORKSPACE_ID }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      CONFIG_PATH: ${{ github.workspace }}/config.example.json
      BASE_DIR: ${{ github.workspace }}
      TZ: 'UTC'

    steps:
      - name: Debug Info
        run: |
          echo "ðŸ• Workflow triggered at: $(date -u)"
          echo "ðŸŽ¯ Event: ${{ github.event_name }}"
          echo "ðŸ”„ Run number: ${{ github.run_number }}"
          echo "ðŸ“… Schedule: ${{ github.event.schedule }}"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ÐŸÐ¾Ð»Ð½Ð°Ñ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð´Ð»Ñ git

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify required secrets
        run: |
          echo "Checking secrets..."
          echo "Event: ${GITHUB_EVENT_NAME}"

          # Basic presence info
          [ -z "$CLICKUP_API_KEY" ] && echo "âŒ CLICKUP_API_KEY missing" || echo "âœ… CLICKUP_API_KEY set"
          # Prefer checking TEAM_ID, but also show WORKSPACE_ID for clarity
          [ -z "$CLICKUP_TEAM_ID" ] && echo "âŒ CLICKUP_TEAM_ID missing" || echo "âœ… CLICKUP_TEAM_ID set"
          [ -z "$CLICKUP_WORKSPACE_ID" ] && echo "â„¹ï¸  CLICKUP_WORKSPACE_ID empty (ok if TEAM_ID is set)" || echo "â„¹ï¸  CLICKUP_WORKSPACE_ID present"
          [ -z "$TELEGRAM_BOT_TOKEN" ] && echo "âŒ TELEGRAM_BOT_TOKEN missing" || echo "âœ… TELEGRAM_BOT_TOKEN set"
          [ -z "$TELEGRAM_CHAT_ID" ] && echo "â„¹ï¸  TELEGRAM_CHAT_ID not set (will use config/cache if available)" || echo "â„¹ï¸  TELEGRAM_CHAT_ID present"

          # Enforce required secrets on schedule/manual runs; be lenient on push
          if [ "$GITHUB_EVENT_NAME" = "schedule" ] || [ "$GITHUB_EVENT_NAME" = "workflow_dispatch" ]; then
            missing=0
            [ -z "$CLICKUP_API_KEY" ] && missing=1
            [ -z "$CLICKUP_TEAM_ID" ] && missing=1
            [ -z "$TELEGRAM_BOT_TOKEN" ] && missing=1
            if [ $missing -eq 1 ]; then
              echo "âŒ Required secrets missing for ${GITHUB_EVENT_NAME} run. Failing early."
              exit 1
            fi
          else
            # For push events, do not fail the job if secrets are missing
            if [ -z "$CLICKUP_API_KEY" ] || [ -z "$CLICKUP_TEAM_ID" ] || [ -z "$TELEGRAM_BOT_TOKEN" ]; then
              echo "âš ï¸  One or more secrets are missing on push event; continuing without failure."
            fi
          fi

      - name: Dispatch ClickUp reminders to Telegram
        continue-on-error: true
        run: |
          echo "ðŸ“¨ Sending ClickUp reminders to Telegram..."
          python send_telegram_reminders.py --verbose ${TELEGRAM_CHAT_ID:+--chat-id "$TELEGRAM_CHAT_ID"}

      - name: Workflow summary
        if: always()
        run: |
          echo "## ðŸ“Š Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
